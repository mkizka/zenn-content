---
title: "monorepoç’°å¢ƒã§VSCodeæ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œã‚‹"
emoji: "ğŸªŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vscode", "pnpm", "monorepo"]
published: true
---

monorepo ç’°å¢ƒã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ VSCode æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œã£ãŸã®ã§ã€æœ‰ç”¨ãã†ãªã‚‚ã®ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ä½œã£ãŸã‚‚ã®ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã„ã¾ã™ã€‚ç´°ã‹ã„ç´¹ä»‹ã¯å€‹äººãƒ–ãƒ­ã‚°ã«æ›¸ããŸã„ã®ã§çœç•¥ã—ã¾ã™ã€‚

https://github.com/mkizka/blogview/tree/main/packages/blogview-vscode

## æ§‹æˆ

- pnpm
- turborepo
- changesets

changets ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³åã®æ›´æ–°ã®ãŸã‚ã ã‘ã«ä½¿ã£ã¦ã€å…¬é–‹ã¯`pnpm -r publish`ã§ã‚„ã£ã¦ã„ã¾ã™ã€‚
turbo ã¯ next.js ã‚’ã‚ˆãä½¿ã†ã®ã§ã€Vercel ç¹‹ãŒã‚Šã¨ã„ã†ã“ã¨ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚ä»Šã®ã¨ã“ã‚ã„ã„æ„Ÿã˜ã§ã™ã€‚

## pnpm ã§ vsce ã‚’ä½¿ã†ã¨ãã®å•é¡Œ

VSCode æ‹¡å¼µæ©Ÿèƒ½ã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã«ä½¿ã† CLI ã§ã‚ã‚‹ vsce ã‚’ pnpm ã§ä½¿ã†ã¨`npm ERR! missing:`ãŒè¡¨ç¤ºã•ã‚Œã¦ãƒ“ãƒ«ãƒ‰å‡ºæ¥ã¾ã›ã‚“ã€‚

https://github.com/microsoft/vscode-vsce/issues/421#issuecomment-687537966

ãƒ“ãƒ«ãƒ‰æ™‚ã«`--no-dependencies`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¯ç„¡ããªã‚Šã¾ã™ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåŒæ¢±ã•ã‚Œãªããªã‚Šã¾ã™ã€‚

ã“ã®å•é¡Œã«ã¶ã¤ã‹ã£ã¦ä¸€æ™‚çš„ã« yarn workspace ã‚’è©¦ã—ã¦ã„ãŸã®ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ãƒ«ãƒ¼ãƒˆã® node_modules ã‚’è¦‹ã«è¡Œã£ã¦ãã‚Œãšä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåŒæ¢±ã•ã‚Œãªã„ã‚ˆã†ã§ã™ã€‚

https://github.com/microsoft/vscode-vsce/issues/300#issue-370671842

### è§£æ±ºç­–

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒãƒ³ãƒ‰ãƒ«ã—ãŸä¸Šã§ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«`--no-dependencies`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

esbuild ã«ã‚ˆã‚‹ãƒãƒ³ãƒ‰ãƒ«ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://code.visualstudio.com/api/working-with-extensions/bundling-extension#using-esbuild

ãƒ“ãƒ«ãƒ‰ç”¨ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨è‰¯ã„ã‚ˆã†ã§ã™ã€‚

```json:package.json
    "vscode:prepublish": "npm run esbuild-base -- --minify",
    "esbuild-base": "esbuild ./src/extension.ts --bundle --outfile=out/main.js --external:vscode --format=cjs --platform=node",
```

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆã¨å…¬é–‹ã®ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```json:package.json
    "package": "pnpm vsce package --no-dependencies",
    "release": "pnpm vsce publish --no-dependencies"
```

## GitHub Action ã§è‡ªå‹•çš„ã« VSCode æ‹¡å¼µæ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

https://code.visualstudio.com/api/working-with-extensions/continuous-integration#github-actions

`vsce publish`ã¯ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³åã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã™ã§ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã™ã‚‹ã®ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³åãŒå¤‰åŒ–ã—ãŸæ™‚ã ã‘å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

```yml:publish.yml
      - name: Publish blogview-vscode
        run: |
          cd packages/blogview-vscode
          PUBLISHED=$(pnpm vsce search blogview-vscode --json | jq -r '.[].versions[0].version')
          CURRENT=$(cat package.json | jq -r '.version')
          if [ "$PUBLISHED" != "$CURRENT" ]; then
            pnpm release -- -p "$VSCE_TOKEN"
          fi
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
```

`vsce search`ã§å…¬é–‹ã—ãŸã„æ‹¡å¼µæ©Ÿèƒ½ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
æ¤œç´¢çµæœã‹ã‚‰ã€GitHub Actions ã®`ubuntu-latest`ã«æ¨™æº–ã§å…¥ã£ã¦ã„ã‚‹`jq`ã§ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³åã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚

å–å¾—ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³åã‚’ package.json ã®å€¤ã¨æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚

## ãŠã‚ã‚Š

monorepo ã§ VSCode æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ã¦æœ‰ç”¨ãã†ãªã‚‚ã®ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

å‚è€ƒã«ãªã‚Œã°ã†ã‚Œã—ã„ã§ã™ã€‚çµ‚ã‚ã‚Šã¾ã™ã€‚
