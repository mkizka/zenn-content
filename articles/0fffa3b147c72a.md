---
title: "ActivityPub実装のテスト自動化"
emoji: "📥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["activitypub", "mastodon", "misskey", "playwright", "docker"]
published: false
---

趣味で自分用のActivityPub実装を作っています。

https://github.com/mkizka/unsocial

ActivityPubを実装するにあたってはMastodonやMisskeyといった他の実装と通信させることで動作確認を行うと思います。

ActivityPubを利用したやりとり(以下、連合)には基本的に独自ドメインとhttpsでの接続が必要です。通常はテストしたい実装と連合相手とをそれぞれどこかのサーバーにデプロイして動作確認すると思いますが、とても手間がかかります。

今回は自作実装、Mastodon、MisskeyをそれぞれDocker Compose上で起動し、相互の接続させることでローカルやCIで自動テストできるようにしてみたので、設定などを紹介します。

なお、開発環境はWSL2、Dockerはdocker-ce( https://get.docker.com )を使用しています。

## MastodonをDockerで起動する
Mastodonの設定は[公式リポジトリ](https://github.com/mastodon/mastodon/blob/eae5c7334ae61c463edd2e3cd03115b897f6e92b/docker-compose.yml)を参考にしました。

https://github.com/mkizka/unsocial/blob/c6f0db56d341b48a165704efd8f916c1177f0d1a/compose.yaml#L52-L97

以下、主なポイントです。

- 環境変数(.env.production)について
  - `LOCAL_DOMAIN=mastodon.localhost` を指定
  - Rubyがmkcertの証明書を使えるように`SSL_CERT_FILE`を指定
  - 他のDockerコンテナからのリクエストを受け付られるように`ALLOWED_PRIVATE_ADDRESSES=172.0.0.0/8`を指定

## MisskeyをDockerで起動する
こちらも[公式リポジトリ](https://github.com/misskey-dev/misskey/blob/develop/docker-compose.yml.example)を眺めつつ追加しました。


https://github.com/mkizka/unsocial/blob/c6f0db56d341b48a165704efd8f916c1177f0d1a/compose.yaml#L121-L141

以下、主なポイントです。

- Misskeyの設定について
  - `url: https://misskey.localhost/`を指定
- 環境変数について
  - レートリミットを無効化するために`NODE_ENV=development`を指定
  - Node.jsがmkcertで作成した証明書を利用できるように`NODE_EXTRA_CA_CERTS`を指定

## それぞれの実装に異なるドメインでアクセスできるようにする
以上でMastodonとMisskeyを起動できました。次はNginxを起動しそれぞれ異なるドメインかつhttpsでアクセスできるようにします。

ドメインといっても使用するのは`.localhost`ドメインです。

https://zenn.dev/kanahebi/articles/ab31fa0fe1c5d2

今回は自作実装に unsocial.localhost、Mastodonに mastodon.localhost、Misskeyに misskey.localhost で接続できるようにします。

各ドメインはそれぞれ 127.0.0.1 が解決されるので、そこへのリクエストをNginxが受け、各実装へ流すようにします。

つまり、以下のようになります。

![今回作成する通信経路のイメージ](/images/0fffa3b147c72a/network.png)

いずれもNginxを経由するようにするのがポイントです。

### Docker内のNginxへのリクエストをlocalhostに流す方法
以下の設定をcompose.yamlに追加し、向き先を`http://host.docker.internal:3000`とするだけです。

```yml
extra_hosts:
  - host.docker.internal:host-gateway
```