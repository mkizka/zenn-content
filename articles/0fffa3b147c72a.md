---
title: "ActivityPub実装のテスト自動化"
emoji: "📥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["activitypub", "mastodon", "misskey", "playwright", "docker"]
published: false
---

趣味で自分用のActivityPub実装を作っています。

https://github.com/mkizka/unsocial

このリポジトリではNext.jsを使った自作の実装に加えて、Docker ComposeでMisskey、Mastodonを起動し、PlaywrightでActivityPubのテストをしています。

構成としては以下のようになっています。

![Docker内のNginxを経由して自作実装、Mastodon、Misskeyが相互接続している様子を表した図](/images/0fffa3b147c72a/network.png)

この記事に書いてあることはこの画像の内容で全部なのですが、これらを整備するにあたって調べたことなどをまとめて紹介します。

なお、本記事では開発環境はWSL2、Dockerはdocker-ce( https://get.docker.com )を使用しています。

## ActivityPub実装をローカルでテストする方法
ActivityPubを実装するにあたっては自作の実装と、MastodonやMisskeyといった他の実装と通信させることで動作確認を行うと思います。

ActivityPubを利用したやりとり(以下、連合)には基本的に独自ドメインとhttpsでの接続が必要です。通常はテストしたい実装と連合相手とをそれぞれどこかのサーバーにデプロイして動作確認すると思いますが、とても手間がかかります。

自分の場合は、それぞれ以下のようにして解決しました。

### 独自ドメインに .localhost を使う
.localhostドメインについては以下の記事などを参照してください。

https://zenn.dev/kanahebi/articles/ab31fa0fe1c5d2

localhostにアクセスする際、実は例えば foo.localhost などとしても同様にアクセスすることが出来ます。

これを利用して misskey.localhost や mastodon.localhost へのリクエストを単一のNginxに受けさせ、リクエスト先のドメインを見て各実装に振り分けることで「独自ドメインでアクセスする」という条件を満たしています。

### https接続に Nginx と mkcert を使う
Nginxを経由して各実装にアクセスできるようになったので、あとはNginxへ証明書を配置するだけです。

証明書の作成にはmkcertを使いました。使用方法はいろいろな解説ページがあると思うので省略します。

https://github.com/FiloSottile/mkcert

## 細かいポイント
各設定を準備する中でつまづいたポイントをまとめます。

### Mastodonの設定
Mastodonの設定は[公式リポジトリ](https://github.com/mastodon/mastodon/blob/eae5c7334ae61c463edd2e3cd03115b897f6e92b/docker-compose.yml)を参考にしました。

https://github.com/mkizka/unsocial/blob/c6f0db56d341b48a165704efd8f916c1177f0d1a/compose.yaml#L52-L97

主なポイントとしては以下の通りです。

- 環境変数( [.env.production](https://github.com/mkizka/unsocial/blob/1e85c64c347a086df8ccc827054898b8ed61965f/docker/mastodon/.env.production) )
  - `LOCAL_DOMAIN=mastodon.localhost`
    - アクセスするドメインを指定する
  - `SSL_CERT_FILE=/mkcert/rootCA.pem`
    - Mastodonを実行するRubyがmkcertの証明書を使うために必要
  - `ALLOWED_PRIVATE_ADDRESSES=172.0.0.0/8`
    - 他のDockerコンテナからのリクエストを受け付けるのに必要

### Misskeyの設定
こちらも[公式リポジトリ](https://github.com/misskey-dev/misskey/blob/develop/docker-compose.yml.example)を眺めつつ追加しました。


https://github.com/mkizka/unsocial/blob/c6f0db56d341b48a165704efd8f916c1177f0d1a/compose.yaml#L121-L141

主なポイントとしては以下の通りです。

- Misskeyの設定( [default.yml](https://github.com/mkizka/unsocial/blob/1e85c64c347a086df8ccc827054898b8ed61965f/docker/misskey/.config/default.yml) )
  - `url: https://misskey.localhost/`を指定
- 環境変数
  - `NODE_ENV=development`
    - Misskeyのレートリミットを無効化するために必要
    - E2Eを何回も実行しているとエラーになる
  - `NODE_EXTRA_CA_CERTS=/mkcert/rootCA.pem`
    - Misskeyを実行するNode.jsがmkcertの証明書を使うために必要

## Nginxの設定
自作実装用の設定。各コメントの通りです。

https://github.com/mkizka/unsocial/blob/1e85c64c347a086df8ccc827054898b8ed61965f/docker/nginx/confs/unsocial.conf

自作実装のみ、プロキシ先をDockerではなく`http://host.docker.internal:3000`としています。

これはNode.jsでの開発はDockerを使わないほうが何かと良い印象があり、自作実装で使用しているNext.jsの`next dev`コマンドで起動するローカルサーバーにそのまま繋がるようにするためです。

Docker Composeに以下のように記述することで、host.docker.internalが使える(Dockerからホスト側のサーバーに接続できる)ようになります。

```yml
extra_hosts:
  - host.docker.internal:host-gateway
```

次にMisskey用の設定。Playwrightでアクセスするとなぜかローディングが終わらないことが何度かあり、sw.jsを叩けないようにしています。
https://github.com/mkizka/unsocial/blob/1e85c64c347a086df8ccc827054898b8ed61965f/docker/nginx/confs/misskey.conf

最後にMastodon用の設定。公式リポジトリのnginx.confを参考にしました。
https://github.com/mkizka/unsocial/blob/1e85c64c347a086df8ccc827054898b8ed61965f/docker/nginx/confs/mastodon.conf

### Docker内のNginxへのリクエストをlocalhostに流す方法
以下の設定をcompose.yamlに追加し、向き先を`http://host.docker.internal:3000`とするだけです。
